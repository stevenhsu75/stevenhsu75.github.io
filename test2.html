<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虛擬眼鏡放在 WebCam 眼睛上</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
    <!-- 引入 Three.js, GLTFLoader, Face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="face-api.js"></script>

    <script>
        var scene, camera, renderer;
        var glassesModel;
        var videoCanvas, videoContext;

        // 設置 Three.js
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // 創建光源
            var light = new THREE.PointLight(0xffffff, 1, 100);
            light.position.set(10, 10, 10);
            scene.add(light);

            // 加載 3D 模型（例如虛擬眼鏡）
            var loader = new THREE.GLTFLoader();
            loader.load('glasses.glb', function (gltf) {
                glassesModel = gltf.scene;
                glassesModel.scale.set(1.1, 1.1, 1.1);  // 調整模型大小
                scene.add(glassesModel);
            });

            // 設置相機位置
            camera.position.set(0, 1, 5);

            // 設置 WebCam 畫布
            videoCanvas = document.createElement('canvas');
            videoCanvas.width = window.innerWidth;
            videoCanvas.height = window.innerHeight;
            videoContext = videoCanvas.getContext('2d');
            document.body.appendChild(videoCanvas);

            // 取得 WebCam 視頻流
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    // 將視頻流中的畫面繪製到 canvas 上
                    var video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();

                    video.onloadeddata = function () {
                        function drawVideo() {
                            videoContext.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);
                            requestAnimationFrame(drawVideo);
                        }
                        drawVideo();
                    };
                })
                .catch(function (err) {
                    console.error('WebCam 錯誤: ' + err);
                });

            // 加載 face-api.js 模型
            loadFaceApi();

            // 渲染動畫
            animate();
        }

        // 加載 face-api.js 模型
        async function loadFaceApi() {
            await faceapi.nets.ssdMobilenetv1.load('/');
            await faceapi.nets.faceLandmark68Net.load('/');
            await faceapi.nets.faceRecognitionNet.load('/');
            detectFace();
        }

        // 偵測面部
        async function detectFace() {
            const detections = await faceapi.detectAllFaces(videoCanvas).withFaceLandmarks();
            if (detections.length > 0) {
                const landmarks = detections[0].landmarks;
                const leftEye = landmarks.getLeftEye();
                const rightEye = landmarks.getRightEye();

                // 找到兩個眼睛的中點，將虛擬眼鏡放在該位置
                const eyeCenterX = (leftEye[3].x + rightEye[3].x) / 2;
                const eyeCenterY = (leftEye[3].y + rightEye[3].y) / 2;

                // 將眼睛中心的位置映射到 3D 空間
                if (glassesModel) {
                    // 注意：根據屏幕大小和比例調整 3D 模型的位置
                    glassesModel.position.set(eyeCenterX / window.innerWidth * 2 - 1, eyeCenterY / window.innerHeight * -2 + 1, 0);
                }
            }

            requestAnimationFrame(detectFace);
        }

        // 渲染動畫
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // 處理視窗大小變化
        window.addEventListener('resize', function() {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            videoCanvas.width = window.innerWidth;
            videoCanvas.height = window.innerHeight;
        });

        // 開始初始化
        init();
    </script>
</body>
</html>
