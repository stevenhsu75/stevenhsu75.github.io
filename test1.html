<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 試戴眼鏡</title>
</head>
<body>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

    <script>
        // 1. 設置相機
        const video = document.getElementById('video');
        navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
            video.srcObject = stream;
        });

        // 2. 確保 OpenCV.js 載入完成
        let opencvReady = false;
        cv['onRuntimeInitialized'] = function() {
            console.log("OpenCV.js 已載入完成");
            opencvReady = true;
        };

        // 3. 載入眼鏡圖片
        let glasses = new Image();
        glasses.src = 'glasses.png';  // 確保圖片在同一個資料夾

        // 4. 偵測臉部
        video.addEventListener("loadeddata", function () {
            setInterval(detectFace, 100);
        });

        function detectFace() {
            if (!opencvReady) return; // 確保 OpenCV.js 已載入

            let videoElement = document.getElementById('video');
            let canvasElement = document.getElementById('canvas');
            let ctx = canvasElement.getContext('2d');

            // 把 <video> 畫面繪製到 <canvas>
            ctx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            // 讀取 <canvas> 影像
            let src = cv.imread(canvasElement);
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            // 載入人臉識別模型 (Haar Cascade)
            let faceCascade = new cv.CascadeClassifier();
            let success = faceCascade.load('haarcascade_frontalface_default.xml');
if (!success) {
    console.error("❌ 無法載入 Haar Cascade XML 檔案！");
    return;
}
            let faces = new cv.RectVector();
            let msize = new cv.Size(100, 100);
            faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, msize, msize);

            if (faces.size() > 0) {
                let face = faces.get(0);
                let eyeX = face.x + face.width * 0.15;
                let eyeY = face.y + face.height * 0.3;
                let eyeWidth = face.width * 0.7;

                // 確保眼鏡圖片已經載入
                if (glasses.complete) {
                    ctx.drawImage(glasses, eyeX, eyeY, eyeWidth, eyeWidth / 3);
                } else {
                    glasses.onload = function () {
                        ctx.drawImage(glasses, eyeX, eyeY, eyeWidth, eyeWidth / 3);
                    };
                }
            }

            src.delete(); gray.delete(); faces.delete(); faceCascade.delete();
        }
    </script>
</body>
</html>
